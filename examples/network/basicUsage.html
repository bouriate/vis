<!doctype html>
<html>
<head>
  <title>Network | Basic usage</title>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script type="text/javascript" src="../../dist/vis.js"></script>

  <style type="text/css">

		body {
			padding: 0px;
			margin: 0px;
			background: #596678 url(img/blueprint-7.png);
			// 596678, 368dce, 13a65a, 45b696, e36761, e3624d, fcc458, 90bbdc
		}
		#mynetwork {
			position: absolute;
			top: 0px; left: 0px;
			bottom: 0px; right: 0px;
		}
  </style>
	<link href="../../dist/vis.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
</head>
<body>

<div id="mynetwork"></div>

<script type="text/javascript">


CanvasRenderingContext2D.prototype.customCircle = function (selected, hover, arrowData) {
	var a = arrowData.angle + Math.PI/4;
	this.save();
	this.translate(arrowData.point.x, arrowData.point.y);
  this.rotate(a);
	this.circle(0, 0, arrowData.length/2);
	this.restore();
}

CanvasRenderingContext2D.prototype.customDiamond = function(selected, hover, arrowData) {
	var a = arrowData.angle + Math.PI/4;
	this.save();
	this.translate(arrowData.point.x, arrowData.point.y);
  this.rotate(a);
	this.square(0, 0, arrowData.length/4);
	this.restore();
}


  // create an array with nodes
  var nodes = new vis.DataSet([
/**    {id: 1, label: 'Рыба', group: 'g1'} ,
    {id: 2, label: 'Змея', group: 'g1'},
    {id: 3, label: 'Мясо', group: 'g2'},
    {id: 4, label: 'Железо', group: 'g2'},
    {id: 5, label: 'Огонь', group: 'g2'},
    {id: 6, label: 'Соль', group: 'g3'}, **/
    {id: 1, fixed: true,label: '               ',  group: 'g3', shape: 'database'}
  ]);


//  EdgeBase.prototype.drawArrowHead = function() {};

  // create an array with edges
  var edges = new vis.DataSet([
/**    {from: 1, to: 3, id: '1', label: 'Дикий\nповар',
		 font: {color: "#f00", size: 40, align: 'left', strokeWidth: 2},
     arrows: { enabled: true, middle: {shape:'customDiamond', background: '#00ff00'} }},
    {from: 1, to: 2, label: 'Жги, пей,\nГУЛЯЙ!!!'},
    {from: 2, to: 4},
    {from: 2, to: 5},
    {from: 6, to: 5},
		{from: 4, to: 3},
		{from: 7, to: 2} **/
  ]);


  // create a network
  var container = document.getElementById('mynetwork');
  var data = {
    nodes: nodes,
    edges: edges
  };
	var options = {
			nodes: {
					shape: 'dot',
					size: 8,
					font: {
							size: 16,
							strokeWidth: 4,
							// background: '#f00',
							strokeColor: '#000',
							color: '#fff'
					},
					borderWidth: 1,
					shadow:false
			},
			groups: {
				'g1': { color: {background:'#368dce',border:'white'}},
				'g2': { color: {background:'#fcc458',border:'#e3624d'}},
				'g3': { shape: 'roundRect', color: {background:'#596678',border:'#13a65a'}}
			},
			edges: {
	/**			"smooth": {
		      "type": "discrete",
		      "forceDirection": "none",
		      "roundness": 0.75
		    }, **/
					arrows: {
						enabled: true,
						from: { shape: 'customCircle' },
					//	middle: { shape: 'customDiamond'}
					},
					font: {
							align: 'middle',
							size: 12,
							strokeColor: '#000',
							color: '#fff'
					},
					width: 1,
				//	length: 600,
				  shadow:false
			}
	};

	var network = new vis.Network(container, data, options);

  function extendNetwork( __network ) {
    __network.getEdgeById = function ( id ) {
      return __network.edgesHandler.body.edges[ id ];
    }
  }

  extendNetwork( network );

	function pickRandomProperty(obj, exclude) {
	    var result;
	    var count = 0;
	    for (var prop in obj) {
				if (prop !== exclude) {
	        if (Math.random() < 1/++count) {
	           result = prop;
					 }
				 }
			}
	    return result;
	}

	var getRandomArticle = function(cb) {
	    return $.getJSON("http://ru.wikipedia.org/w/api.php?action=query&generator=random&grnnamespace=0&prop=extracts&explaintext&exintro=&format=json&callback=?", function (data) {
					cb(data);
			});
	}

function addRandomNode(x,y,isfixed) {
	var id = vis.util.randomUUID();

  if (nodes.length>50 || Math.random()<1/3) {
		console.log(nodes.length, edges.length);
		var did = pickRandomProperty(nodes._data, '1');
		var edges2remove = network.nodesHandler.getConnectedEdges(did);
	//	network.nodesHandler.remove([did]);
		nodes.remove(did);
		edges2remove.forEach( function(e) {
			edges.remove(e);
		})
	}

	var database = (Math.random()<1/10)?true:false;
	var square = database ? false : ((Math.random()<1/5)?true:false);

  var shape = square ? 'square' : (
		database ? 'database' : 'dot'
	)

	var r = nodes.add({
		id:id,
		group: Math.floor(Math.random()*4),
		x: x,
		y: y,
		fixed: isfixed,
		shape: shape,
	})

	getRandomArticle(function(data) {
		$.each( data.query.pages, function(e, page) {
			var sliced = page.title.slice(0,15);
			if (sliced.length < page.title.length) {
				sliced += '...';
			}
			network.body.nodes[id].setOptions({label:sliced, title: page.title})
			network.redraw();
		/**	network.fit({
				animation: {
					duration: 2000
				}
			}); **/
		})
	});

	var middle = (Math.random()<1/3)?true:false;
  var arrows = {};
	if (middle) {
		arrows = { middle: { shape: 'customDiamond'} }
	}
	var to = pickRandomProperty(nodes._data);
	edges.add({
		to: id,
		from: to,
		length: 100 + Math.random()*200,
		arrows: arrows
	})
}

	network.on("doubleClick", function (params) {
	  params.event = "[original event]";
		if ((params.nodes.length===0) && (params.edges.length===0)) {
			addRandomNode(params.pointer.canvas.x, params.pointer.canvas.y, true)
		}
	});

	setInterval( addRandomNode, 500 )

</script>

</body>
</html>
